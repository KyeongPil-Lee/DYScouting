#include <Include/DYTool.h>
#include <BDT/Trial/v06_noOS/dataset/weights/TMVAClassification_BDTG.class.C>



// -- histogram for the dimuon events in 81 < m < 101 GeV
class ZPeakHistContainer
{
public:
  TString type_ = "";

  vector<TH1D*> vec_hist_;

  TH1D* h_mu_pt_;
  TH1D* h_mu_eta_;
  TH1D* h_mu_phi_;

  TH1D* h_mu_pt_lead_;
  TH1D* h_mu_eta_lead_;
  TH1D* h_mu_phi_lead_;

  TH1D* h_mu_pt_sub_;
  TH1D* h_mu_eta_sub_;
  TH1D* h_mu_phi_sub_;

  TH1D* h_diMu_mass_;
  TH1D* h_diMu_rap_;
  TH1D* h_diMu_pt_;

  ZPeakHistContainer(TString type)
  {
    type_ = type;
    Init();
  }

  void Fill(DYTool::MuPair& muPair, Double_t weight)
  {
    Fill_SingleMu( muPair.first_, weight );
    Fill_SingleMu( muPair.second_, weight );

    h_mu_pt_lead_->Fill( muPair.first_.pt, weight );
    h_mu_eta_lead_->Fill( muPair.first_.eta, weight );
    h_mu_phi_lead_->Fill( muPair.first_.phi, weight );

    h_mu_pt_sub_->Fill( muPair.second_.pt, weight );
    h_mu_eta_sub_->Fill( muPair.second_.eta, weight );
    h_mu_phi_sub_->Fill( muPair.second_.phi, weight );

    h_diMu_mass_->Fill( muPair.mass, weight );
    h_diMu_rap_->Fill( muPair.rap, weight );
    h_diMu_pt_->Fill( muPair.pt, weight );
  }

  void Fill_SingleMu(DYTool::Muon& mu, Double_t weight)
  {
    h_mu_pt_->Fill( mu.pt, weight );
    h_mu_eta_->Fill( mu.eta, weight );
    h_mu_phi_->Fill( mu.phi, weight );
  }

  void Write(TFile *f_output)
  {
    for(const auto& h: vec_hist_ )
      h->Write();

    cout << "[ZPeakHistContainer (type = " << type_ << ")]: saved in " << f_output->GetName() << endl;
  }


private:
  void Init()
  {
    TH1::SetDefaultSumw2(kTRUE);
    TH1::AddDirectory(kFALSE);

    h_mu_pt_  = new TH1D("h_mu_pt_"+type_, "", 10000, 0, 10000); vec_hist_.push_back( h_mu_pt_ );
    h_mu_eta_ = new TH1D("h_mu_eta_"+type_, "", 60, -3, 3);      vec_hist_.push_back( h_mu_eta_ );
    h_mu_phi_ = new TH1D("h_mu_phi_"+type_, "", 80, -4, 4);      vec_hist_.push_back( h_mu_phi_ );

    h_mu_pt_lead_  = new TH1D("h_mu_pt_lead_"+type_, "", 10000, 0, 10000); vec_hist_.push_back( h_mu_pt_lead_ );
    h_mu_eta_lead_ = new TH1D("h_mu_eta_lead_"+type_, "", 60, -3, 3);      vec_hist_.push_back( h_mu_eta_lead_ );
    h_mu_phi_lead_ = new TH1D("h_mu_phi_lead_"+type_, "", 80, -4, 4);      vec_hist_.push_back( h_mu_phi_lead_ );

    h_mu_pt_sub_  = new TH1D("h_mu_pt_sub_"+type_, "", 10000, 0, 10000); vec_hist_.push_back( h_mu_pt_sub_ );
    h_mu_eta_sub_ = new TH1D("h_mu_eta_sub_"+type_, "", 60, -3, 3);      vec_hist_.push_back( h_mu_eta_sub_ );
    h_mu_phi_sub_ = new TH1D("h_mu_phi_sub_"+type_, "", 80, -4, 4);      vec_hist_.push_back( h_mu_phi_sub_ );

    h_diMu_mass_ = new TH1D("h_diMu_mass_"+type_, "", 20, 81, 101);   vec_hist_.push_back( h_diMu_mass_ );
    h_diMu_rap_  = new TH1D("h_diMu_rap_"+type_, "", 60, -3, 3);      vec_hist_.push_back( h_diMu_rap_ );
    h_diMu_pt_   = new TH1D("h_diMu_pt_"+type_, "", 10000, 0, 10000); vec_hist_.push_back( h_diMu_pt_ );
  }

};

class ZPeakHistProducer: public DYTool::ClassTemplate
{
public:
  ZPeakHistProducer(): ClassTemplate()
  {

  }

  void Run()
  {
    Setup();
    CheckSampleInfo();
    StartTimer();

    // -- define the histogram
    // -- histogram for the runs not in vec_run_: unknownRun
    ZPeakHistContainer* hist_unknownRun = new ZPeakHistContainer("unknownRun");

    TChain *chain = new TChain("DYTree/ntuple");
    DYTool::AddNtupleToChain(chain, sampleInfo_.ntuplePathFile);

    DYTool::DYTree *ntuple = new DYTool::DYTree( chain );

    Int_t nEvent = chain->GetEntries();
    cout << "\t[Total Events: " << nEvent << "]" << endl;

    DYTool::PUReweightTool* PUTool = new DYTool::PUReweightTool("2018");

    vector<std::string> vec_inputVarName = {
      "diMuNormVtxChi2", "diMuDEta", "diMuDPhi", 
      "caloMET_pt", 
      "nMuonHit_lead", "nMatchedStation_lead", "nPixelHit_lead", "nTrackerLayer_lead", "normChi2_lead", "relTrkIso_lead", 
      "nMuonHit_sub", "nMatchedStation_sub", "nPixelHit_sub", "nTrackerLayer_sub", "normChi2_sub", "relTrkIso_sub"
    };

    ReadBDTG* BDTClassifier = new ReadBDTG(vec_inputVarName);

    for(Int_t i=0; i<nEvent; i++)
    {
      DYTool::loadBar(i+1, nEvent, 100, 100);
      
      ntuple->GetEvent(i);

      Double_t genWeight;
      ntuple->genWeight < 0 ? genWeight = -1 : genWeight = 1;

      // Double_t totWeight = sampleInfo_.normFactor * genWeight;
      Double_t totWeight = genWeight;
      if( sampleInfo_.isMC ) totWeight = genWeight * PUTool->Weight( ntuple->truePU );

      // -- only DY->mumu or DY->ee events according to its name -- //
      if( DYTool::SelectGenEventBySampleType(sampleInfo_.type, ntuple) )
      {
        Bool_t isDYEvent = kFALSE;
        DYTool::MuPair DYMuPair = DYTool::EventSelection_BDTInput_noOS(ntuple, isDYEvent);
        if( isDYEvent )
        {
          Int_t runIndex = FindRunIndex(ntuple->runNum);
          if( runIndex != -1 ) vec_histContainer_[runIndex]->Fill( DYMuPair, totWeight );
          else                 hist_unknownRun->Fill( DYMuPair, totWeight );

          // -- if BDT needs to be applied, comment "on" below lines
          // vector<Double_t> vec_BDTInputVar = {
          //   DYMuPair.normVtxChi2, DYMuPair.dEta, DYMuPair.dPhi,
          //   ntuple->caloMET_pt,
          //   (Double_t)DYMuPair.first_.nMuonHit, (Double_t)DYMuPair.first_.nMatchedStation, (Double_t)DYMuPair.first_.nPixelHit, (Double_t)DYMuPair.first_.nTrackerLayer, DYMuPair.first_.normChi2, DYMuPair.first_.relTrkIso,
          //   (Double_t)DYMuPair.second_.nMuonHit, (Double_t)DYMuPair.second_.nMatchedStation, (Double_t)DYMuPair.second_.nPixelHit, (Double_t)DYMuPair.second_.nTrackerLayer, DYMuPair.second_.normChi2, DYMuPair.second_.relTrkIso
          // };

          // Double_t mvaValue = BDTClassifier->GetMvaValue( vec_BDTInputVar );
          // Double_t WP = 0.466016; // -- 78% signal efficiency with 90% background rejection

          // if (mvaValue > WP )
          // {

          // }
        }
      } // -- sample type selection

    } // -- end of event iteration

    TString outputName = TString::Format("ROOTFile_ZPeakHistProducer_%s.root", sampleInfo_.type.Data());
    TFile *f_output = TFile::Open(outputName, "RECREATE");
    f_output->cd();

    for(auto histContainer : vec_histContainer_)
      histContainer->Write( f_output );

    hist_unknownRun->Write( f_output );

    f_output->Close();

    PrintRunTime();
  }

private:
  vector<ZPeakHistContainer*> vec_histContainer_;
  vector<Int_t> vec_run_     = {315257, 315259, 315264, 315265, 315267, 315270, 315322, 315339, 315357, 315361, 315363, 315366, 315420, 315488, 315489, 315490, 315506, 315510, 315512, 315543, 315555, 315556, 315557, 315640, 315641, 315642, 315644, 315645, 315646, 315647, 315648, 315689, 315690, 315702, 315703, 315704, 315705, 315713, 315721, 315741, 315764, 315770, 315784, 315785, 315786, 315790, 315800, 315801, 315840, 315973, 315974, 316058, 316059, 316060, 316061, 316062, 316082, 316110, 316111, 316113, 316114, 316153, 316186, 316187, 316199, 316200, 316201, 316202, 316216, 316217, 316218, 316219, 316239, 316240, 316241, 316271, 316361, 316362, 316363, 316377, 316378, 316379, 316380, 316455, 316457, 316469, 316470, 316472, 316505, 316569, 316590, 316613, 316615, 316666, 316667, 316700, 316701, 316702, 316715, 316716, 316717, 316718, 316719, 316720, 316721, 316722, 316723, 316758, 316766, 316876, 316877, 316879, 316928, 316985, 316993, 316994, 316995, 317080, 317087, 317089, 317182, 317212, 317213, 317279, 317291, 317292, 317297, 317319, 317320, 317338, 317339, 317340, 317382, 317383, 317391, 317392, 317435, 317438, 317475, 317478, 317484, 317488, 317527, 317591, 317626, 317640, 317641, 317648, 317649, 317650, 317661, 317663, 317683, 317696, 318733, 318828, 318872, 318874, 318876, 318877, 319077, 319337, 319347, 319348, 319349, 319449, 319450, 319456, 319459, 319486, 319503, 319524, 319526, 319528, 319579, 319625, 319639, 319656, 319657, 319658, 319659, 319678, 319687, 319697, 319698, 319756, 319840, 319841, 319847, 319848, 319849, 319851, 319853, 319854, 319908, 319909, 319910, 319912, 319913, 319914, 319915, 319941, 319942, 319950, 319991, 319992, 319993, 320002, 320006, 320010, 320011, 320012, 320023, 320024, 320025, 320026, 320038, 320039, 320040, 320059, 320060, 320061, 320062, 320063, 320064, 320065, 320673, 320674, 320688, 320712, 320757, 320804, 320807, 320809, 320821, 320822, 320823, 320824, 320838, 320840, 320841, 320853, 320854, 320855, 320856, 320857, 320858, 320859, 320887, 320888, 320916, 320917, 320920, 320933, 320934, 320936, 320941, 320980, 320995, 320996, 321004, 321005, 321006, 321007, 321009, 321010, 321011, 321012, 321051, 321055, 321067, 321068, 321069, 321119, 321121, 321122, 321124, 321126, 321134, 321138, 321140, 321149, 321165, 321166, 321167, 321177, 321178, 321218, 321219, 321221, 321230, 321231, 321232, 321233, 321262, 321283, 321294, 321295, 321296, 321305, 321311, 321312, 321313, 321393, 321396, 321397, 321414, 321415, 321431, 321432, 321433, 321434, 321436, 321457, 321461, 321475, 321710, 321712, 321730, 321732, 321735, 321755, 321758, 321760, 321773, 321774, 321775, 321776, 321777, 321778, 321780, 321781, 321813, 321815, 321817, 321818, 321820, 321831, 321832, 321833, 321834, 321879, 321880, 321887, 321908, 321909, 321917, 321919, 321933, 321960, 321961, 321973, 321975, 321988, 321990, 322013, 322014, 322022, 322040, 322057, 322068, 322079, 322106, 322113, 322118, 322179, 322201, 322204, 322222, 322252, 322317, 322319, 322322, 322324, 322332, 322348, 322355, 322356, 322381, 322407, 322430, 322431, 322480, 322492, 322510, 322599, 322602, 322603, 322605, 322617, 322625, 322633, 323414, 323423, 323470, 323471, 323472, 323473, 323474, 323475, 323487, 323488, 323492, 323493, 323495, 323524, 323525, 323526, 323693, 323696, 323702, 323725, 323726, 323727, 323755, 323775, 323778, 323790, 323794, 323841, 323857, 323940, 323954, 323976, 323978, 323980, 323983, 323997, 324021, 324022, 324077, 324201, 324202, 324205, 324206, 324207, 324209, 324237, 324245, 324293, 324315, 324318, 324420, 324729, 324747, 324764, 324765, 324769, 324772, 324785, 324791, 324835, 324840, 324841, 324846, 324878, 324897, 324970, 324980, 324997, 324998, 324999, 325000, 325001, 325022, 325057, 325097, 325098, 325099, 325100, 325101, 325110, 325117, 325159, 325168, 325169, 325170, 325172};
  // -- /fb
  vector<Double_t> vec_lumi_ = {0.007929497, 0.013918864, 0.039703388, 0.006454507, 0.037143311, 0.078981117, 0.180062920, 0.093349061, 0.151930725, 0.118531849, 0.014489096, 0.100182760, 0.258566396, 0.190563067, 0.103438191, 0.002520994, 0.027983158, 0.103172328, 0.236871400, 0.036886267, 0.021968881, 0.008395188, 0.084134393, 0.010512485, 0.001237309, 0.031431097, 0.063159684, 0.161090551, 0.191964439, 0.008018192, 0.015226137, 0.329958838, 0.119001932, 0.022853106, 0.158162019, 0.014739015, 0.132814780, 0.353734703, 0.210579169, 0.023717251, 0.114011154, 0.121796189, 0.051799834, 0.106003338, 0.021848143, 0.173123579, 0.206215401, 0.098534603, 0.354111468, 0.278586191, 0.018532205, 0.137197208, 0.170426968, 0.198479234, 0.006146917, 0.000698283, 0.141359586, 0.081969483, 0.015161958, 0.020491266, 0.367994967, 0.256240431, 0.015153677, 0.512428751, 0.401961320, 0.002226180, 0.110093155, 0.075106131, 0.171479086, 0.088158861, 0.243232708, 0.048978441, 0.209319054, 0.283682524, 0.053194396, 0.029698080, 0.026413888, 0.053916088, 0.004611485, 0.001986070, 0.003336673, 0.008222157, 0.175280166, 0.009607083, 0.326273293, 0.148877856, 0.116869505, 0.066237151, 0.401220030, 0.485569309, 0.189247294, 0.031466211, 0.049127397, 0.279381290, 0.042140099, 0.114304211, 0.143933326, 0.095461886, 0.003000536, 0.061792771, 0.063385896, 0.090222571, 0.032449482, 0.041732114, 0.003260078, 0.134760529, 0.009621132, 0.455682721, 0.561052774, 0.216379022, 0.111051479, 0.036513199, 0.044417240, 0.172546110, 0.074473713, 0.004777100, 0.186194514, 0.007844260, 0.243200389, 0.212904926, 0.406207245, 0.051172376, 0.125489076, 0.065891594, 0.274028870, 0.085006647, 0.123798905, 0.053514561, 0.460767275, 0.013631072, 0.065749760, 0.140596348, 0.024139434, 0.022451239, 0.002717287, 0.490656629, 0.360612921, 0.049709578, 0.025761150, 0.007937242, 0.160355997, 0.181128073, 0.452099029, 0.111116517, 0.528939540, 0.261179265, 0.268315019, 0.033881916, 0.193211576, 0.255996426, 0.375651112, 0.153301355, 0.117851782, 0.228786857, 0.002792197, 0.013229261, 0.091854514, 0.099565217, 0.046587025, 0.160548836, 0.016371875, 0.232388818, 0.210856031, 0.005006475, 0.040843828, 0.249173726, 0.207045612, 0.052015625, 0.017212101, 0.020314797, 0.090959188, 0.456701499, 0.069659575, 0.058410906, 0.818490479, 0.070596043, 0.409340341, 0.086471826, 0.051824096, 0.061716393, 0.021787667, 0.095424824, 0.016052913, 0.060561287, 0.036295265, 0.490204543, 0.049718970, 0.020280330, 0.000903537, 0.019081513, 0.173552091, 0.001137038, 0.071203488, 0.053716327, 0.018295828, 0.001120242, 0.304865167, 0.013437223, 0.012566235, 0.006879860, 0.086802323, 0.094417188, 0.017468906, 0.065935971, 0.282111415, 0.065586502, 0.182675815, 0.050203468, 0.114140140, 0.074676692, 0.061138036, 0.018060690, 0.098834607, 0.126440979, 0.030113234, 0.050085703, 0.218712390, 0.008200272, 0.177428533, 0.040908654, 0.015725006, 0.018270053, 0.006956471, 0.022166104, 0.064866603, 0.227086186, 0.064592146, 0.033749177, 0.130855199, 0.069579800, 0.116683595, 0.319033307, 0.000348408, 0.106230704, 0.060432928, 0.149814403, 0.080025310, 0.164020053, 0.092366066, 0.141043050, 0.050468155, 0.118065454, 0.039644924, 0.146559259, 0.033490847, 0.052859822, 0.037521088, 0.004926672, 0.104361547, 0.009500190, 0.006635005, 0.477801747, 0.024013428, 0.051965819, 0.210460582, 0.078320032, 0.015638078, 0.038407528, 0.025796208, 0.048288004, 0.046906478, 0.019195813, 0.051704227, 0.202763102, 0.014732928, 0.057206632, 0.028948830, 0.004974448, 0.311577321, 0.125495500, 0.172706969, 0.147136741, 0.049557775, 0.058668389, 0.015831462, 0.120346156, 0.185307787, 0.078957429, 0.008164269, 0.141976762, 0.116949370, 0.434674653, 0.000389898, 0.003380938, 0.274126989, 0.151674214, 0.023034517, 0.282500585, 0.181189493, 0.005906206, 0.022670378, 0.014523657, 0.006057920, 0.231852526, 0.001669120, 0.119780879, 0.020610486, 0.201490287, 0.011876596, 0.601904551, 0.000473243, 0.060265688, 0.026586081, 0.049689179, 0.365018162, 0.052262513, 0.380801771, 0.142213696, 0.055907925, 0.016577963, 0.042731538, 0.180882406, 0.138441929, 0.482761896, 0.021013094, 0.471912521, 0.017235399, 0.084378140, 0.102670881, 0.344691952, 0.023661290, 0.213437556, 0.037517590, 0.146153421, 0.021058783, 0.043723139, 0.004807240, 0.010304681, 0.058616866, 0.036058295, 0.113674716, 0.068009102, 0.120243809, 0.005120206, 0.148473508, 0.138015405, 0.032068958, 0.248042890, 0.115961844, 0.074190773, 0.049809506, 0.090170659, 0.041375820, 0.276941304, 0.145314737, 0.340569377, 0.261219957, 0.001488823, 0.101007248, 0.007304486, 0.132126192, 0.358666936, 0.145783784, 0.384021716, 0.081031948, 0.001146111, 0.006669868, 0.452968644, 0.013692424, 0.008235478, 0.232599447, 0.140244760, 0.281859052, 0.040789720, 0.268228934, 0.469749616, 0.084335391, 0.311166308, 0.092744223, 0.420357700, 0.019245910, 0.055502234, 0.292464047, 0.069259748, 0.313995681, 0.414112209, 0.033876145, 0.234583361, 0.178729681, 0.169958460, 0.156140903, 0.214230370, 0.109337400, 0.287515085, 0.002228890, 0.094350581, 0.024109024, 0.002693892, 0.089623887, 0.136645564, 0.335273291, 0.050945617, 0.006204142, 0.021037074, 0.080200218, 0.075495647, 0.019315198, 0.054519627, 0.077807771, 0.014194080, 0.154166173, 0.186197456, 0.005823197, 0.027375069, 0.032346526, 0.172934401, 0.242648282, 0.064950697, 0.040083352, 0.088847729, 0.145958433, 0.118533090, 0.014606471, 0.246903637, 0.296639246, 0.046767743, 0.270935867, 0.276737455, 0.016056603, 0.155038205, 0.095513180, 0.426706208, 0.015140930, 0.014398816, 0.021951778, 0.067731897, 0.056791397, 0.128791789, 0.252485124, 0.127785561, 0.242582801, 0.362857357, 0.039241165, 0.022963460, 0.017522834, 0.004054579, 0.016078704, 0.074991780, 0.417199145, 0.513035432, 0.070436667, 0.099840257, 0.199727029, 0.014796593, 0.308246151, 0.030065379, 0.087679541, 0.046770044, 0.018782623, 0.185797535, 0.245007227, 0.085856011, 0.027721689, 0.301008029, 0.068552956, 0.403016934, 0.050228783, 0.479465581, 0.513294960, 0.038586760, 0.114235368, 0.003883479, 0.094663582, 0.119138042, 0.433385704, 0.120048335, 0.017770097, 0.002038523, 0.139170738, 0.074467205, 0.118270296, 0.003259474, 0.085216684, 0.061439969, 0.004288854, 0.005577620, 0.263142487, 0.067635724};

  void Setup()
  {
    Int_t nRun = (Int_t)vec_run_.size();
    for(Int_t i_run=0; i_run<nRun; i_run++)
    {
      TString str_run = TString::Format("%d", vec_run_[i_run]);
      ZPeakHistContainer* hist_temp = new ZPeakHistContainer(str_run);
      vec_histContainer_.push_back(hist_temp);
    }
  }

  Int_t FindRunIndex(Int_t runNum)
  {
    Int_t theIndex = -1;
    for(UInt_t i_run=0; i_run<vec_run_.size(); i_run++)
    {
      if( runNum == vec_run_[i_run] )
      {
        theIndex = i_run;
        break;
      }
    }

    if( theIndex == -1 )
      cout << "[FindRunIndex] The run = " << runNum << " is not found in vec_run!! ... need to check" << endl;

    return theIndex;
  }

};